<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/css/bootstrap.min.css" integrity="sha384-Zug+QiDoJOrZ5t4lssLdxGhVrurbmBWopoEl+M6BdEfwnCJZtKxi1KgxUyJq13dy"
        crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/js/bootstrap.min.js" integrity="sha384-a5N7Y/aK3qNeh15eJKGWxsqtnX/wWdSZSKp+81YjTmS15nvnvxKHuzaWwXHDli+4"
        crossorigin="anonymous"></script>
    <script src="https://use.fontawesome.com/07fb4515ea.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Courgette|Pacifico" rel="stylesheet">
    <title>Socket.io Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-size: 12px;
            font-family: 'Open Sans', sans-serif;
            color: #777;
            background: #f9f9f9;
        }

        #bar {
            background: url(https://socket.io/assets/img/galaxy.jpg);
            height: 7px;
            background-size: cover;
            background-position: left 60%;
            position: fixed;
            top: 0;
            width: 100%;
            overflow: hidden;
            z-index: 1000;
        }

        h2 {
            font-family: 'Pacifico', cursive;
            color: black;
            text-align: center;
            margin-top: 10px;
        }

        select {
            width: 400px;
            text-align-last: center;
        }

        .card-header {
            text-align: center;
        }

        .card-block {
            height: 390px;
        }

        #messages {
            list-style-type: none;
            margin: 0;
            padding: 15px;
            overflow-y: auto;
            height: 400px;
        }

        #messages li {
            margin: 15px 0;
        }

        #messages li img {
            width: 45px;
            height: 45px;
            border-radius: 50em;
            -moz-border-radius: 50em;
            -webkit-border-radius: 50em;
        }

        img {
            max-width: 100%;
        }

        #messages li .chat-body {
            margin-left: 70px;
            background-color: #fff;
            position: relative;
            font-size: 11px;
            padding: 10px;
            border: 1px solid #f1f5fc;
            box-shadow: 0 1px 1px rgba(0, 0, 0, .05);
            -moz-box-shadow: 0 1px 1px rgba(0, 0, 0, .05);
            -webkit-box-shadow: 0 1px 1px rgba(0, 0, 0, .05);
        }

        #messages li .chat-body .header {
            padding-bottom: 5px;
            border-bottom: 1px solid #f1f5fc;
        }

        #messages li .chat-body p {
            margin: 0;
        }

        #messages li .chat-body:before {
            position: absolute;
            top: 10px;
            left: -8px;
            display: inline-block;
            background: #fff;
            width: 16px;
            height: 16px;
            border-top: 1px solid #f1f5fc;
            border-left: 1px solid #f1f5fc;
            content: '';
            transform: rotate(-45deg);
            -webkit-transform: rotate(-45deg);
            -moz-transform: rotate(-45deg);
            -ms-transform: rotate(-45deg);
            -o-transform: rotate(-45deg);
        }

        .primary-font {
            color: #3c8dbc;
        }
    </style>
</head>

<body>
    <div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">è®©æˆ‘çœ‹çœ‹è°æ¥äº†ã¥(>^Ï‰^
                        <)å–µ</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label for="username" class="col-form-label">çŒœçŒœæˆ‘æ˜¯è° (âœªÏ‰âœª):</label>
                            <input type="text" class="form-control" id="username">
                        </div>
                        <div class="form-group">
                            <label for="">é€‰æ‹©ä¸€ä¸ªå°åŠ¨ç‰©å§: </label>
                            <select class="form-control" id="iconSelect">
                                <option value="https://res.cloudinary.com/louismelo/image/upload/v1515142755/lion.png">ğŸ¦ å¤§è¥¿å‡  ğŸ¦</option>
                                <option value="https://res.cloudinary.com/louismelo/image/upload/v1515142755/lion.png">ğŸ¬ å°æµ·ç–¼ ğŸ¬</option>
                                <option value="https://res.cloudinary.com/louismelo/image/upload/v1515142756/wolf.png">ğŸº å¤§é£å›Š ğŸº</option>
                                <option value="https://res.cloudinary.com/louismelo/image/upload/v1515142756/tiger.png">ğŸ¯ å¤§è„‘æ–§ ğŸ¯</option>
                                <option value="https://res.cloudinary.com/louismelo/image/upload/v1515142756/mouse.png">ğŸ­ å°è„‘è®¸ ğŸ­</option>
                            </select>
                        </div>
                        <!-- <div class="form-group">
                                    <label for="message-text" class="col-form-label">Message:</label>
                                    <textarea class="form-control" id="message-text"></textarea>
                                </div> -->
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="loginBtn">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <div id="bar"></div>
    <div class="container">
        <h2>ğŸ‚Louisnowâ€˜sHomeğŸ‚</h2>
        <div class="row">
            <div class="col-md-6 offset-md-3 col-sm-12">
                <div class="card">
                    <div class="card-header">
                        ğŸ‰ æ¬¢è¿æ¥åˆ°å€ªä¸‰å²ç”Ÿæ—¥PARTYçš„ç›´æ’­é—´
                    </div>
                    <div class="card-block">
                        <ul id="messages">
                        </ul>
                    </div>
                    <div class="card-footer text-center">å½“å‰åœ¨çº¿äººæ•°: xxx</div>
                </div>
                <!-- change name button -->
                <button class="btn btn-link" id="changeName" style="display:none">æ”¹ä¸ªåå­—</button>
                <hr>
                <div class="input-group">
                    <input class="form-control border no-shadow" placeholder="è¯·è¾“å…¥..." id="m" style="border-top-right-radius:5px;border-bottom-right-radius:5px"> &nbsp
                    <span class="input-group-btn">
                        <button class="btn btn-success" type="button" style="border-top-right-radius:5px;border-bottom-right-radius:5px" id="sendBtn">
                            <i class="fa fa-paper-plane-o" aria-hidden="true"></i>
                            å‘é€
                        </button>
                    </span>
                    &nbsp
                    <div class="btn-group dropup">
                        <button class="btn btn-warning text-white dropdown-toggle" data-toggle="dropdown" type="button">
                            <i class="fa fa-gift" aria-hidden="true"></i>
                            ç¤¼ç‰©
                        </button>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
    <script>
        $(function () {
            var socket = io();
            var username;
            var icon;
            var welcome = 'ğŸ‰ æ¬¢è¿æ¥åˆ°å€ªä¸‰å²ç”Ÿæ—¥PARTYçš„ç›´æ’­é—´';

            // å‘é€èŠå¤©æ¶ˆæ¯
            $('#sendBtn').click(function () {
                username = Cookies.get('username');
                icon = Cookies.get('icon');
                var message = $('#m').val();
                var time = (new Date()).toLocaleString();
                var msg = { 'username': username, 'icon': icon, 'message': message, 'time': time };

                socket.emit('chatMessage', msg);

                // organize chat body
                // var img = $('<img>').attr('src', 'https://image.flaticon.com/icons/svg/25/25231.svg');
                // var imgSpan = $('<span>').addClass('pull-left').append(img);

                // var userBlock = $('<strong>').addClass('primary-font').text(username);
                // var timeBlock = $('<small>').addClass('pull-right').addClass('text-muted').text(time);
                // var pBlock = $('<p>').text(message);
                // var headerBlock = $('<div>').addClass('header');
                // headerBlock.append(userBlock);
                // headerBlock.append(timeBlock);
                // var chatBodyBlock = $('<div>').addClass('chat-body').addClass('clearfix');
                // chatBodyBlock.append(headerBlock);
                // chatBodyBlock.append(pBlock);
                // var li = $('<li>').addClass('clearfix');
                // li.append(imgSpan);
                // li.append(chatBodyBlock);
                // $('#messages').append(li);
                appendMessage(msg);
                $('#m').val('');
                $('#messages').animate({ scrollTop: $('#messages').prop('scrollHeight') }, 500);
                return false;
            });

            // æ¥æ”¶å†å²æ¶ˆæ¯
            socket.on('loadMessages', function(docs){
                docs.forEach(function(doc){
                    appendMessage(doc);
                });
                $('#messages').animate({ scrollTop: $('#messages').prop('scrollHeight') }, 500);
            });

            // æ¥æ”¶èŠå¤©æ¶ˆæ¯
            socket.on('chatMessage', function (msg) {
                // var img = $('<img/>').attr('src', 'https://image.flaticon.com/icons/svg/25/25231.svg');
                // var imgSpan = $('<span>').addClass('pull-left').append(img);

                // var userBlock = $('<strong>').addClass('primary-font').text(msg.username);
                // var timeBlock = $('<small>').addClass('pull-right').addClass('text-muted').text(msg.time);
                // var pBlock = $('<p>').text(msg.message);
                // var headerBlock = $('<div>').addClass('header');
                // headerBlock.append(userBlock);
                // headerBlock.append(timeBlock);
                // var chatBodyBlock = $('<div>').addClass('chat-body').addClass('clearfix');
                // chatBodyBlock.append(headerBlock);
                // chatBodyBlock.append(pBlock);
                // var li = $('<li>').addClass('clearfix');
                // li.append(imgSpan);
                // li.append(chatBodyBlock);
                // $('#messages').append(li);
                appendMessage(msg);
                $('#messages').animate({ scrollTop: $('#messages').prop('scrollHeight') }, 500);
            });

            $('#loginBtn').click(function () {
                username = $('#username').val();
                icon = $('#iconSelect').val();
                $('#loginModal').modal('hide');
                Cookies.set('username', username);
                Cookies.set('icon', icon);
                $('.card-header').text(welcome + 'ï¼Œ' + username);

                socket.emit('userLogin', { 'username': username, 'icon': icon });
            });

            socket.on('connect', function () {
                if (Cookies.get('username')) {
                    username = Cookies.get('username');
                    icon = Cookies.get('icon');
                    $('.card-header').text(welcome + 'ï¼Œ' + username);
                    socket.emit('userLogin', { 'username': username, 'icon': icon });
                } else {
                    // var date = new Date();
                    // username = 'Anonymous-' + date.getTime();
                    $('#loginModal').modal();
                }
            });

            socket.on('userLogin', function (data) {
                $('.card-footer').text('å½“å‰åœ¨çº¿äººæ•°: ' + data.online);
                console.log(data.loginInfo);
            });

            socket.on('userLogout', function (data) {
                console.log(data.username + 'has logged out.');
                $('.card-footer').text('å½“å‰åœ¨çº¿äººæ•°: ' + data.online);
            });

            $('#changeName').click(function () {
                $('#loginModal').modal();
            });
        });

        function appendMessage(messageRec) {
            var img = $('<img/>').attr('src', messageRec.icon);
            var imgSpan = $('<span>').addClass('pull-left').append(img);

            var userBlock = $('<strong>').addClass('primary-font').text(messageRec.username);
            var timeBlock = $('<small>').addClass('pull-right').addClass('text-muted').text(messageRec.time);
            var pBlock = $('<p>').text(messageRec.message);
            var headerBlock = $('<div>').addClass('header');
            headerBlock.append(userBlock);
            headerBlock.append(timeBlock);
            var chatBodyBlock = $('<div>').addClass('chat-body').addClass('clearfix');
            chatBodyBlock.append(headerBlock);
            chatBodyBlock.append(pBlock);
            var li = $('<li>').addClass('clearfix');
            li.append(imgSpan);
            li.append(chatBodyBlock);
            $('#messages').append(li);
        }
    </script>
</body>

</html>